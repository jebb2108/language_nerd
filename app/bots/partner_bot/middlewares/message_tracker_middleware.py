import asyncio
from collections import defaultdict
from typing import Callable, Any, Dict, TYPE_CHECKING
from aiogram import BaseMiddleware
from aiogram.exceptions import TelegramBadRequest
from aiogram.types import CallbackQuery, Message

from app.dependencies import get_redis
from app.services.redis import RedisService
from config import config
from logging_config import opt_logger as log

if TYPE_CHECKING:
    from aiogram import Bot

logger = log.setup_logger('message_tracker', config.LOG_LEVEL)

class MessageTrackerMiddleware(BaseMiddleware):
    def __init__(self, bot: "Bot"):
        self.bot = bot
        self.edited_messages = defaultdict(list)
        self.search_messages = defaultdict(list)
        self.active_searches = defaultdict(bool)

    async def __call__(
        self, handler: Callable, event: Any, data: Dict[str, Any]
    ) -> Any:

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –í–•–û–î–Ø–©–ò–ï —Å–æ–±—ã—Ç–∏—è –î–û handler
        if isinstance(event, CallbackQuery):
            # await self.track_callback(event)
            logger.debug(f"Message deemed callable b4 processing")
            pass

        # –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        result = await handler(event, data)


        if isinstance(result, Message):
            redis = await get_redis()
            logger.debug(f"Post process of message %s", result.message_id)
            await self.track_message(result, redis)

        # –î–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ò–°–•–û–î–Ø–©–ò–• —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        # asyncio.create_task(self._post_process(event, data))

        return result


    async def track_message(self, message: Message, redis: "RedisService"):
        """–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            # –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            if message.text.startswith("üîç"):
                await self.start_search(message, redis)

        except Exception as e:
            logger.error(f"Error in track_message: {e}")


    async def start_search(self, message: "Message", redis: "RedisService") -> None:
        """–ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞"""
        cid = message.chat.id
        mid =  message.message_id
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        self.active_searches[cid] = True
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis —Å TTL
        await redis.mark_msg_as_search(message)
        await redis.save_sent_message(message)
        # –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
        await self.cleanup_previous_searches(cid, redis)
        res = await redis.get_search_message_id(cid)
        logger.info(f"Started tracking search: chat={cid}, message={mid} -> {res}")


    async def cleanup_previous_searches(self, cid: int, redis: "RedisService") -> None:
        """–û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞"""
        logger.debug("Starting to clean old messages ...")
        # –ò–≤–∑–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –∏–∑ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        for indx in await redis.get_sent_queue(cid):
            if self.active_searches[cid] and not await redis.check_search_msg(cid, indx):

                try:
                    await self.bot.delete_message(cid, int(indx))

                except TelegramBadRequest:
                    logger.debug("User deleted this message %s on their own", indx)

                else:
                    logger.debug("This message %s deleted", indx)

                await redis.delete_msg_from_queue(cid, indx)

            # –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ (!) –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Cancel
            elif self.active_searches[cid] and await redis.check_search_msg(cid, indx):
                logger.debug("User %s canceled search. Stopped on msg %s", cid, indx)
                self.active_searches[cid] = False

        logger.debug("Stopped cleaning old messages")